# Go Redis Stream æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿ

è¿™æ˜¯ä¸€ä¸ªåŸºäº Redis Stream å’Œ go-redis åº“æ„å»ºçš„å®Œç¾æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

### 1. Pending List å¤„ç†æœºåˆ¶
- **ä¼˜å…ˆå¤„ç† Pending æ¶ˆæ¯**ï¼šæ¶ˆè´¹è€…å¯åŠ¨æ—¶é¦–å…ˆå¤„ç† PendingList ä¸­çš„æ¶ˆæ¯
- **æ¶ˆæ¯æŠ¢å¤ºæœºåˆ¶**ï¼šå½“æ¶ˆè´¹è€…åœ¨è®¾è®¡æ—¶é—´å†…æœªå¤„ç†å®Œæ¶ˆæ¯ï¼Œå…¶ä»–æ¶ˆè´¹è€…å¯ä»¥æŠ¢å¤ºè¿‡å»
- **è‡ªåŠ¨ ACK**ï¼šå¤„ç†å®Œæˆåè‡ªåŠ¨ç¡®è®¤æ¶ˆæ¯

### 2. æ¶ˆæ¯åœæ­¢å¤„ç†æ§åˆ¶
- **åŠ¨æ€åœæ­¢**ï¼šå¯ä»¥æ–¹ä¾¿åœ°åœæ­¢ç‰¹å®šæ¶ˆæ¯çš„å¤„ç†
- **å…¨å±€æ§åˆ¶**ï¼šåœæ­¢åæ‰€æœ‰æ¶ˆè´¹è€…éƒ½ä¸ä¼šå¤„ç†è¯¥æ¶ˆæ¯
- **æ¢å¤å¤„ç†**ï¼šå¯ä»¥é‡æ–°å¯ç”¨è¢«åœæ­¢çš„æ¶ˆæ¯å¤„ç†

### 3. Topicç»ˆæ­¢åŠŸèƒ½
- **å®Œå…¨æ¸…ç©º**ï¼šå¯ä»¥ç»ˆæ­¢æ•´ä¸ªtopicï¼Œæ¸…ç©ºæ‰€æœ‰æœªæ¶ˆè´¹çš„æ¶ˆæ¯
- **æ¶ˆè´¹è€…ç»„æ¸…ç†**ï¼šè‡ªåŠ¨åˆ é™¤æ‰€æœ‰ç›¸å…³çš„æ¶ˆè´¹è€…ç»„
- **å³æ—¶ç”Ÿæ•ˆ**ï¼šæ­£åœ¨æ¶ˆè´¹çš„æ¶ˆè´¹è€…ä¼šç«‹å³åœæ­¢
- **å¯é‡å»º**ï¼šç»ˆæ­¢åå¯ä»¥é‡æ–°åˆ›å»ºåŒåtopic

### 4. æ¶ˆè´¹è€…å¼€å§‹ä½ç½®é…ç½®
- **ä»æœ€æ–°ä½ç½®å¼€å§‹**ï¼šåªæ¶ˆè´¹å¯åŠ¨åçš„æ–°æ¶ˆæ¯ï¼ˆé»˜è®¤ï¼‰
- **ä»æœ€æ—©ä½ç½®å¼€å§‹**ï¼šæ¶ˆè´¹æ‰€æœ‰å†å²æ¶ˆæ¯å’Œæ–°æ¶ˆæ¯
- **ä»æŒ‡å®šIDå¼€å§‹**ï¼šä»æŒ‡å®šçš„æ¶ˆæ¯IDå¼€å§‹æ¶ˆè´¹
- **çµæ´»é…ç½®**ï¼šåˆ›å»ºæ¶ˆè´¹è€…æ—¶å¯ä»¥çµæ´»é€‰æ‹©å¼€å§‹ä½ç½®

### 5. æ¶ˆæ¯æ¸…ç†æœºåˆ¶
- **è‡ªåŠ¨æ¸…ç†**ï¼šå®šæœŸæ¸…ç†å·²è¢«æ‰€æœ‰æ¶ˆè´¹è€…ç»„å¤„ç†çš„æ¶ˆæ¯
- **æ‰‹åŠ¨æ¸…ç†**ï¼šæŒ‰éœ€æ¸…ç†ï¼Œå®Œå…¨æ§åˆ¶æ¸…ç†æ—¶æœº
- **å®‰å…¨æœºåˆ¶**ï¼šåªæ¸…ç†è¢«æ‰€æœ‰æ¶ˆè´¹è€…ç»„ç¡®è®¤ä¸”è¶³å¤Ÿè€çš„æ¶ˆæ¯
- **æ‰¹é‡å¤„ç†**ï¼šé¿å…ä¸€æ¬¡æ€§åˆ é™¤å¤ªå¤šæ¶ˆæ¯å½±å“æ€§èƒ½

### 6. æ‰¹é‡æ¶ˆæ¯å¤„ç†
- **æ‰¹é‡å¤„ç†å™¨**ï¼šæ”¯æŒä¸€æ¬¡å¤„ç†å¤šæ¡æ¶ˆæ¯ï¼Œæé«˜ååé‡
- **æ™ºèƒ½åˆ†æ‰¹**ï¼šè‡ªåŠ¨æŒ‰é…ç½®çš„æ‰¹é‡å¤§å°åˆ†æ‰¹å¤„ç†
- **è¶…æ—¶æœºåˆ¶**ï¼šä¸è¶³ä¸€æ‰¹æ—¶ç­‰å¾…è¶…æ—¶åå¤„ç†ç°æœ‰æ¶ˆæ¯
- **æ··åˆæ¨¡å¼**ï¼šåŒæ—¶æ”¯æŒæ‰¹é‡å’Œå•æ¡å¤„ç†å™¨
- **å‘åå…¼å®¹**ï¼šç°æœ‰å•æ¡å¤„ç†å™¨æ— éœ€ä¿®æ”¹å³å¯ä½¿ç”¨

### 7. è‡ªåŠ¨åœæ­¢æœºåˆ¶
- **æ™ºèƒ½æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹topicæˆ–æ¶ˆè´¹è€…ç»„è¢«åˆ é™¤
- **ä¼˜é›…åœæ­¢**ï¼šæ¶ˆè´¹è€…è‡ªåŠ¨åœæ­¢ï¼Œé¿å…æ— æ•ˆé‡è¯•
- **å¤–éƒ¨ç›‘å¬**ï¼šæä¾›Done()é€šé“ä¾›å¤–éƒ¨ç›‘å¬åœæ­¢äº‹ä»¶
- **çŠ¶æ€åŒºåˆ†**ï¼šåŒºåˆ†è‡ªåŠ¨åœæ­¢å’Œæ‰‹åŠ¨åœæ­¢

### 8. é«˜å¯ç”¨æ€§è®¾è®¡
- **å¤šæ¶ˆè´¹è€…æ”¯æŒ**ï¼šæ”¯æŒå¤šä¸ªæ¶ˆè´¹è€…å¹¶å‘å¤„ç†
- **æ¶ˆæ¯ç«äº‰å¤„ç†**ï¼šå¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥ç«äº‰å¤„ç†æ¶ˆæ¯
- **æ•…éšœæ¢å¤**ï¼šæ¶ˆè´¹è€…é‡å¯åè‡ªåŠ¨å¤„ç†æœªå®Œæˆçš„æ¶ˆæ¯

## ğŸ“ é¡¹ç›®ç»“æ„

```
goStream/
â”œâ”€â”€ main.go                 # ä¸»ç¨‹åºï¼Œæ¼”ç¤ºå®Œæ•´åŠŸèƒ½
â”œâ”€â”€ go.mod                  # Go æ¨¡å—æ–‡ä»¶
â”œâ”€â”€ queue/
â”‚   â””â”€â”€ message_queue.go    # æ¶ˆæ¯é˜Ÿåˆ—æ ¸å¿ƒå®ç°
â”œâ”€â”€ handlers/
â”‚   â”œâ”€â”€ email_handler.go    # é‚®ä»¶å¤„ç†å™¨ç¤ºä¾‹
â”‚   â””â”€â”€ order_handler.go    # è®¢å•å¤„ç†å™¨ç¤ºä¾‹
â””â”€â”€ README.md              # é¡¹ç›®è¯´æ˜æ–‡æ¡£
```

## ğŸ› ï¸ å®‰è£…å’Œè¿è¡Œ

### å‰ç½®æ¡ä»¶
1. Go 1.24+
2. Redis æœåŠ¡å™¨

### å®‰è£…ä¾èµ–
```bash
go mod tidy
```

### å¯åŠ¨ Redis
```bash
# ä½¿ç”¨ Docker å¯åŠ¨ Redis
docker run -d -p 6379:6379 redis:latest

# æˆ–è€…ä½¿ç”¨æœ¬åœ° Redis
redis-server
```

### è¿è¡Œç¨‹åº

#### å¿«é€Ÿå¼€å§‹
```bash
# å¯åŠ¨RedisæœåŠ¡
make redis-up

# è¿è¡Œä¸»ç¨‹åºï¼ˆå®Œæ•´æ¼”ç¤ºï¼‰
make run

# æˆ–è€…è¿è¡Œç®€å•æµ‹è¯•
make test

# æˆ–è€…è¿è¡ŒPendingæ¶ˆæ¯å¤„ç†æ¼”ç¤º
make test-pending

# æˆ–è€…è¿è¡ŒTopicç»ˆæ­¢åŠŸèƒ½æ¼”ç¤º
make test-terminate

# æˆ–è€…è¿è¡Œå¼€å§‹ä½ç½®æ¼”ç¤º
make demo-start-position

# æˆ–è€…è¿è¡Œæ¶ˆæ¯æ¸…ç†æ¼”ç¤º
make demo-cleanup

# æˆ–è€…è¿è¡Œæ‰¹é‡å¤„ç†æ¼”ç¤º
make demo-batch

# æˆ–è€…è¿è¡Œè‡ªåŠ¨åœæ­¢æ¼”ç¤º
make demo-auto-stop
```

#### æ‰‹åŠ¨è¿è¡Œ
```bash
# ç¼–è¯‘é¡¹ç›®
make build

# è¿è¡Œä¸»ç¨‹åº
./gostream

# æˆ–è€…ç›´æ¥è¿è¡Œ
go run main.go
```

## ğŸ’¡ æ ¸å¿ƒç»„ä»¶è¯´æ˜

### MessageQueue æ ¸å¿ƒç±»
```go
type MessageQueue struct {
    client       *redis.Client
    streamName   string
    groupName    string
    consumerName string
    handlers     map[string]MessageHandler
    stopChan     chan struct{}
    wg           sync.WaitGroup
    mu           sync.RWMutex
    stopped      bool
    
    // æ¶ˆæ¯åœæ­¢å¤„ç†çš„æ§åˆ¶
    stoppedMessages map[string]bool
    stopMsgMu       sync.RWMutex
}
```

### å…³é”®æ–¹æ³•

#### 1. å¯åŠ¨æ¶ˆæ¯é˜Ÿåˆ—
```go
func (mq *MessageQueue) Start(ctx context.Context) error
```
- åˆ›å»ºæ¶ˆè´¹è€…ç»„
- å¯åŠ¨ Pending æ¶ˆæ¯å¤„ç† goroutine
- å¯åŠ¨æ–°æ¶ˆæ¯å¤„ç† goroutine

#### 2. å¤„ç† Pending æ¶ˆæ¯
```go
func (mq *MessageQueue) processPendingMessages(ctx context.Context)
```
- è·å– PendingList ä¸­çš„æ¶ˆæ¯
- ä½¿ç”¨ XCLAIM æŠ¢å¤ºè¶…æ—¶æ¶ˆæ¯
- ä¼˜å…ˆå¤„ç†å®Œæ‰€æœ‰ Pending æ¶ˆæ¯

#### 3. æ¶ˆæ¯å¤„ç†æ§åˆ¶
```go
func (mq *MessageQueue) StopMessageProcessing(messageID string)
func (mq *MessageQueue) ResumeMessageProcessing(messageID string)
```
- åŠ¨æ€åœæ­¢/æ¢å¤ç‰¹å®šæ¶ˆæ¯çš„å¤„ç†
- çº¿ç¨‹å®‰å…¨çš„æ§åˆ¶æœºåˆ¶

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### 1. åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—

#### åŸºæœ¬åˆ›å»ºï¼ˆé»˜è®¤ä»æœ€æ–°ä½ç½®å¼€å§‹ï¼‰
```go
rdb := redis.NewClient(&redis.Options{
    Addr: "localhost:6379",
})

mq := queue.NewMessageQueue(rdb, "task-stream", "task-group", "consumer-1")
```

#### æŒ‡å®šå¼€å§‹ä½ç½®åˆ›å»º
```go
// ä»æœ€æ—©ä½ç½®å¼€å§‹æ¶ˆè´¹ï¼ˆå¤„ç†æ‰€æœ‰å†å²æ¶ˆæ¯ï¼‰
mq := queue.NewMessageQueueWithStartPosition(rdb, "task-stream", "task-group", "consumer-1", queue.StartFromEarliest)

// ä»æœ€æ–°ä½ç½®å¼€å§‹æ¶ˆè´¹ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰
mq := queue.NewMessageQueueWithStartPosition(rdb, "task-stream", "task-group", "consumer-1", queue.StartFromLatest)

// ä»æŒ‡å®šæ¶ˆæ¯IDå¼€å§‹æ¶ˆè´¹
mq := queue.NewMessageQueueFromSpecificID(rdb, "task-stream", "task-group", "consumer-1", "1234567890-0")
```

#### é…ç½®æ¶ˆæ¯æ¸…ç†ç­–ç•¥
```go
// å¯ç”¨è‡ªåŠ¨æ¸…ç†
cleanupPolicy := &queue.CleanupPolicy{
    EnableAutoCleanup: true,
    CleanupInterval:   time.Minute * 5,  // 5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    MaxStreamLength:   10000,            // è¶…è¿‡10000æ¡æ¶ˆæ¯æ—¶æ¸…ç†
    MinRetentionTime:  time.Hour * 1,    // æ¶ˆæ¯è‡³å°‘ä¿ç•™1å°æ—¶
    BatchSize:         100,              // æ¯æ‰¹æ¸…ç†100æ¡æ¶ˆæ¯
}
mq.SetCleanupPolicy(cleanupPolicy)
```

#### é…ç½®æ‰¹é‡å¤„ç†
```go
// å¯ç”¨æ‰¹é‡å¤„ç†
batchConfig := &queue.BatchConfig{
    EnableBatch:  true,
    BatchSize:    10,                   // é»˜è®¤æ‰¹é‡å¤§å°
    BatchTimeout: time.Millisecond * 500, // 500msè¶…æ—¶
    MaxWaitTime:  time.Second * 2,      // æœ€å¤§ç­‰å¾…2ç§’
}
mq.SetBatchConfig(batchConfig)
```

### 2. æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨

#### å•æ¡æ¶ˆæ¯å¤„ç†å™¨
```go
// å®ç° MessageHandler æ¥å£
type EmailHandler struct{}

func (h *EmailHandler) GetMessageType() string {
    return "email"
}

func (h *EmailHandler) Handle(ctx context.Context, msg *queue.Message) error {
    // å¤„ç†é‚®ä»¶é€»è¾‘
    return nil
}

// æ³¨å†Œå¤„ç†å™¨
mq.RegisterHandler(&EmailHandler{})
```

#### æ‰¹é‡æ¶ˆæ¯å¤„ç†å™¨
```go
// å®ç° BatchMessageHandler æ¥å£
type EmailBatchHandler struct{}

func (h *EmailBatchHandler) GetMessageType() string {
    return "email"
}

func (h *EmailBatchHandler) GetBatchSize() int {
    return 5 // æ¯æ‰¹å¤„ç†5å°é‚®ä»¶ï¼Œè¿”å›0ä½¿ç”¨å…¨å±€é…ç½®
}

func (h *EmailBatchHandler) HandleBatch(ctx context.Context, messages []*queue.Message) error {
    // æ‰¹é‡å¤„ç†é‚®ä»¶é€»è¾‘
    fmt.Printf("æ‰¹é‡å‘é€ %d å°é‚®ä»¶\n", len(messages))
    return nil
}

// æ³¨å†Œæ‰¹é‡å¤„ç†å™¨
mq.RegisterBatchHandler(&EmailBatchHandler{})
```

### 3. å¯åŠ¨æ¶ˆè´¹è€…
```go
ctx := context.Background()
err := mq.Start(ctx)
if err != nil {
    log.Fatal(err)
}
```

### 4. å‘å¸ƒæ¶ˆæ¯
```go
messageID, err := mq.PublishMessage(ctx, "email", map[string]interface{}{
    "to":      "user@example.com",
    "subject": "æ¬¢è¿æ³¨å†Œ",
    "body":    "æ¬¢è¿æ‚¨æ³¨å†Œæˆ‘ä»¬çš„æœåŠ¡ï¼",
}, map[string]string{
    "priority": "high",
})
```

### 5. æ§åˆ¶æ¶ˆæ¯å¤„ç†
```go
// åœæ­¢ç‰¹å®šæ¶ˆæ¯çš„å¤„ç†
mq.StopMessageProcessing(messageID)

// æ¢å¤æ¶ˆæ¯å¤„ç†
mq.ResumeMessageProcessing(messageID)

// ç»ˆæ­¢æ•´ä¸ªtopicï¼ˆæ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯å’Œæ¶ˆè´¹è€…ç»„ï¼‰
err := mq.TerminateTopic(ctx)

// è·å–topicä¿¡æ¯
info, err := mq.GetTopicInfo(ctx)

// æ‰‹åŠ¨æ¸…ç†æ¶ˆæ¯
cleaned, err := mq.CleanupMessages(ctx)
```

### 6. ç›‘å¬è‡ªåŠ¨åœæ­¢
```go
// å¯åŠ¨æ¶ˆè´¹è€…
consumer := queue.NewMessageQueue(rdb, "my-stream", "my-group", "consumer-1")
consumer.Start(ctx)

// ç›‘å¬è‡ªåŠ¨åœæ­¢äº‹ä»¶
go func() {
    <-consumer.Done()
    if consumer.IsAutoStopped() {
        log.Println("æ¶ˆè´¹è€…å› topicåˆ é™¤è€Œè‡ªåŠ¨åœæ­¢")
        // æ‰§è¡Œæ¸…ç†é€»è¾‘
    } else {
        log.Println("æ¶ˆè´¹è€…æ‰‹åŠ¨åœæ­¢")
    }
}()

// æ‰‹åŠ¨åœæ­¢æ¶ˆè´¹è€…
consumer.Stop()
```

## ğŸ¯ æ ¸å¿ƒå·¥ä½œæµç¨‹

### æ¶ˆè´¹è€…å¯åŠ¨æµç¨‹
1. **åˆ›å»ºæ¶ˆè´¹è€…ç»„**ï¼šå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°çš„æ¶ˆè´¹è€…ç»„
2. **å¤„ç† Pending æ¶ˆæ¯**ï¼š
   - æŸ¥è¯¢ PendingList
   - ä½¿ç”¨ XCLAIM æŠ¢å¤ºè¶…æ—¶æ¶ˆæ¯
   - å¤„ç†å¹¶ ACK æ¶ˆæ¯
3. **å¤„ç†æ–°æ¶ˆæ¯**ï¼š
   - ä½¿ç”¨ XREADGROUP è¯»å–æ–°æ¶ˆæ¯
   - å¤„ç†å¹¶ ACK æ¶ˆæ¯

### æ¶ˆæ¯å¤„ç†æµç¨‹
1. **æ¶ˆæ¯è§£æ**ï¼šä» Redis Stream æ¶ˆæ¯ä¸­è§£æå‡ºç»“æ„åŒ–æ•°æ®
2. **åœæ­¢æ£€æŸ¥**ï¼šæ£€æŸ¥æ¶ˆæ¯æ˜¯å¦è¢«æ ‡è®°ä¸ºåœæ­¢å¤„ç†
3. **å¤„ç†å™¨æŸ¥æ‰¾**ï¼šæ ¹æ®æ¶ˆæ¯ç±»å‹æ‰¾åˆ°å¯¹åº”çš„å¤„ç†å™¨
4. **æ¶ˆæ¯å¤„ç†**ï¼šè°ƒç”¨å¤„ç†å™¨å¤„ç†æ¶ˆæ¯
5. **æ¶ˆæ¯ç¡®è®¤**ï¼šå¤„ç†æˆåŠŸå ACK æ¶ˆæ¯

### æ¶ˆæ¯æŠ¢å¤ºæœºåˆ¶
- ä½¿ç”¨ Redis Stream çš„ XCLAIM å‘½ä»¤
- å½“æ¶ˆæ¯åœ¨ PendingList ä¸­è¶…è¿‡ä¸€å®šæ—¶é—´æœªè¢«å¤„ç†æ—¶
- å…¶ä»–æ¶ˆè´¹è€…å¯ä»¥æŠ¢å¤ºè¿™äº›æ¶ˆæ¯è¿›è¡Œå¤„ç†
- ç¡®ä¿æ¶ˆæ¯ä¸ä¼šå› ä¸ºæ¶ˆè´¹è€…æ•…éšœè€Œä¸¢å¤±

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹ Stream ä¿¡æ¯
```bash
# æŸ¥çœ‹ Stream åŸºæœ¬ä¿¡æ¯
redis-cli XINFO STREAM task-stream

# æŸ¥çœ‹æ¶ˆè´¹è€…ç»„ä¿¡æ¯
redis-cli XINFO GROUPS task-stream

# æŸ¥çœ‹ Pending æ¶ˆæ¯
redis-cli XPENDING task-stream task-group
```

### æ—¥å¿—è¾“å‡º
ç¨‹åºä¼šè¾“å‡ºè¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
- æ¶ˆæ¯å‘å¸ƒæ—¥å¿—
- æ¶ˆæ¯å¤„ç†æ—¥å¿—
- Pending æ¶ˆæ¯å¤„ç†æ—¥å¿—
- é”™è¯¯å’Œå¼‚å¸¸æ—¥å¿—

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **Redis ç‰ˆæœ¬**ï¼šéœ€è¦ Redis 5.0+ æ”¯æŒ Stream åŠŸèƒ½
2. **æ¶ˆæ¯å¹‚ç­‰æ€§**ï¼šç¡®ä¿æ¶ˆæ¯å¤„ç†å™¨å…·æœ‰å¹‚ç­‰æ€§
3. **é”™è¯¯å¤„ç†**ï¼šå®ç°é€‚å½“çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
4. **èµ„æºæ¸…ç†**ï¼šç¨‹åºé€€å‡ºæ—¶æ­£ç¡®å…³é—­æ¶ˆæ¯é˜Ÿåˆ—

## ğŸ”® æ‰©å±•åŠŸèƒ½

### å¯ä»¥æ·»åŠ çš„åŠŸèƒ½
1. **æ­»ä¿¡é˜Ÿåˆ—**ï¼šå¤„ç†å¤±è´¥çš„æ¶ˆæ¯
2. **æ¶ˆæ¯é‡è¯•**ï¼šè‡ªåŠ¨é‡è¯•å¤±è´¥çš„æ¶ˆæ¯
3. **æ¶ˆæ¯ä¼˜å…ˆçº§**ï¼šæ”¯æŒæ¶ˆæ¯ä¼˜å…ˆçº§å¤„ç†
4. **ç›‘æ§æŒ‡æ ‡**ï¼šæ·»åŠ  Prometheus ç›‘æ§
5. **é…ç½®ç®¡ç†**ï¼šæ”¯æŒé…ç½®æ–‡ä»¶å’Œç¯å¢ƒå˜é‡

è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿæä¾›äº†ä¸€ä¸ªå®Œæ•´çš„ã€ç”Ÿäº§å°±ç»ªçš„è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥ç›´æ¥ç”¨äºå®é™…é¡¹ç›®ä¸­ã€‚

## ğŸ§¹ æ¶ˆæ¯æ¸…ç†

### è‡ªåŠ¨æ¸…ç†å·²å¤„ç†æ¶ˆæ¯

å½“æ¶ˆæ¯è¢«æ‰€æœ‰æ¶ˆè´¹è€…ç»„éƒ½å¤„ç†å®Œæˆåï¼Œç³»ç»Ÿå¯ä»¥è‡ªåŠ¨æ¸…ç†è¿™äº›æ¶ˆæ¯ï¼Œé˜²æ­¢Redis Streamæ— é™å¢é•¿ï¼š

1. **å®‰å…¨æ£€æŸ¥**ï¼šåªæ¸…ç†è¢«æ‰€æœ‰æ¶ˆè´¹è€…ç»„ç¡®è®¤ä¸”è¶³å¤Ÿè€çš„æ¶ˆæ¯
2. **è‡ªåŠ¨æ¸…ç†**ï¼šå®šæœŸæ£€æŸ¥å¹¶æ¸…ç†ï¼Œä¿æŒStreamåœ¨åˆç†å¤§å°
3. **æ‰‹åŠ¨æ¸…ç†**ï¼šæŒ‰éœ€æ¸…ç†ï¼Œå®Œå…¨æ§åˆ¶æ¸…ç†æ—¶æœº
4. **æ‰¹é‡å¤„ç†**ï¼šé¿å…ä¸€æ¬¡æ€§åˆ é™¤å¤ªå¤šæ¶ˆæ¯å½±å“æ€§èƒ½

### æµ‹è¯•æ¶ˆæ¯æ¸…ç†

```bash
# è¿è¡Œæ¶ˆæ¯æ¸…ç†æµ‹è¯•
make test-cleanup

# è¿è¡Œæ¶ˆæ¯æ¸…ç†æ¼”ç¤º
make demo-cleanup
```

è¯¦ç»†çš„æ¶ˆæ¯æ¸…ç†è¯´æ˜è¯·å‚è€ƒï¼š[MESSAGE_CLEANUP.md](MESSAGE_CLEANUP.md)

## ğŸš€ æ‰¹é‡æ¶ˆæ¯å¤„ç†

### é«˜æ€§èƒ½æ‰¹é‡å¤„ç†

å½“éœ€è¦å¤„ç†å¤§é‡æ¶ˆæ¯æ—¶ï¼Œæ‰¹é‡å¤„ç†å¯ä»¥æ˜¾è‘—æé«˜ååé‡ï¼š

1. **å‡å°‘ç½‘ç»œå¼€é”€**ï¼šä¸€æ¬¡å¤„ç†å¤šæ¡æ¶ˆæ¯
2. **æé«˜å¤„ç†æ•ˆç‡**ï¼šæ‰¹é‡APIè°ƒç”¨ï¼ˆå¦‚æ‰¹é‡é‚®ä»¶å‘é€ï¼‰
3. **æ™ºèƒ½åˆ†æ‰¹**ï¼šè‡ªåŠ¨æŒ‰é…ç½®å¤§å°åˆ†æ‰¹
4. **è¶…æ—¶ä¿æŠ¤**ï¼šé¿å…æ¶ˆæ¯ç§¯å‹

### æµ‹è¯•æ‰¹é‡å¤„ç†

```bash
# è¿è¡Œæ‰¹é‡å¤„ç†æµ‹è¯•
make test-batch

# è¿è¡Œæ‰¹é‡å¤„ç†æ¼”ç¤º
make demo-batch
```

### æ‰¹é‡å¤„ç†ç‰¹æ€§

- **çµæ´»é…ç½®**ï¼šå¯é…ç½®æ‰¹é‡å¤§å°ã€è¶…æ—¶æ—¶é—´
- **ç±»å‹åˆ†ç»„**ï¼šç›¸åŒç±»å‹çš„æ¶ˆæ¯è‡ªåŠ¨åˆ†ç»„æ‰¹é‡å¤„ç†
- **å›é€€æœºåˆ¶**ï¼šæ²¡æœ‰æ‰¹é‡å¤„ç†å™¨æ—¶è‡ªåŠ¨å›é€€åˆ°å•æ¡å¤„ç†
- **æ··åˆæ”¯æŒ**ï¼šåŒä¸€æ¶ˆè´¹è€…å¯åŒæ—¶æ³¨å†Œæ‰¹é‡å’Œå•æ¡å¤„ç†å™¨

## ğŸš¨ é”™è¯¯å¤„ç†

### Topicåˆ é™¤æ—¶çš„é”™è¯¯å¤„ç†

å½“æ¶ˆè´¹è€…æ­£åœ¨å¤„ç†æ¶ˆæ¯æ—¶ï¼Œå¦‚æœtopicè¢«åˆ é™¤ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š

1. **æ£€æµ‹é”™è¯¯**ï¼šè¯†åˆ«`NOGROUP`ã€`ERR no such key`ç­‰é”™è¯¯æ¨¡å¼
2. **ä¼˜é›…åœæ­¢**ï¼šåœæ­¢æ¶ˆè´¹è€…é¿å…æ— æ•ˆæ“ä½œ  
3. **å®Œæˆå¤„ç†**ï¼šè®©æ­£åœ¨å¤„ç†çš„æ¶ˆæ¯å®Œæˆ
4. **è¯¦ç»†æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰é”™è¯¯ä¾¿äºè°ƒè¯•

### æµ‹è¯•é”™è¯¯å¤„ç†

```bash
# è¿è¡Œé”™è¯¯å¤„ç†æµ‹è¯•
make test-errors
```

è¯¦ç»†çš„é”™è¯¯å¤„ç†è¯´æ˜è¯·å‚è€ƒï¼š[ERROR_HANDLING.md](ERROR_HANDLING.md)

## ğŸ›‘ è‡ªåŠ¨åœæ­¢åŠŸèƒ½

### æ™ºèƒ½çš„æ¶ˆè´¹è€…è‡ªåŠ¨åœæ­¢

å½“topicè¢«åˆ é™¤æˆ–æ¶ˆè´¹è€…ç»„è¢«åˆ é™¤æ—¶ï¼Œæ¶ˆè´¹è€…ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶ä¼˜é›…åœæ­¢ï¼š

1. **æ™ºèƒ½æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹Redis Streamæˆ–æ¶ˆè´¹è€…ç»„è¢«åˆ é™¤
2. **ä¼˜é›…åœæ­¢**ï¼šæ¶ˆè´¹è€…è‡ªåŠ¨åœæ­¢ï¼Œé¿å…æ— æ•ˆçš„é‡è¯•å’Œé”™è¯¯æ—¥å¿—
3. **å¤–éƒ¨ç›‘å¬**ï¼šæä¾›Done()é€šé“ä¾›å¤–éƒ¨ç›‘å¬åœæ­¢äº‹ä»¶
4. **çŠ¶æ€åŒºåˆ†**ï¼šé€šè¿‡IsAutoStopped()åŒºåˆ†è‡ªåŠ¨åœæ­¢å’Œæ‰‹åŠ¨åœæ­¢

### ä½¿ç”¨åœºæ™¯

- **å¾®æœåŠ¡æ¶æ„**ï¼šåœ¨å®¹å™¨åŒ–ç¯å¢ƒä¸­å®ç°ä¼˜é›…çš„æœåŠ¡å…³é—­
- **åŠ¨æ€æ‰©ç¼©å®¹**ï¼šå½“topicè¢«åˆ é™¤æ—¶ï¼Œç›¸å…³æ¶ˆè´¹è€…è‡ªåŠ¨åœæ­¢
- **é”™è¯¯å¤„ç†**ï¼šé¿å…å› topicåˆ é™¤å¯¼è‡´çš„æ— æ•ˆé‡è¯•
- **èµ„æºç®¡ç†**ï¼šè‡ªåŠ¨é‡Šæ”¾ä¸å†éœ€è¦çš„æ¶ˆè´¹è€…èµ„æº

### æµ‹è¯•è‡ªåŠ¨åœæ­¢

```bash
# è¿è¡Œè‡ªåŠ¨åœæ­¢æµ‹è¯•
make test-auto-stop

# è¿è¡Œè‡ªåŠ¨åœæ­¢æ¼”ç¤º
make demo-auto-stop
```

### ä½¿ç”¨ç¤ºä¾‹

```go
// åˆ›å»ºæ¶ˆè´¹è€…
consumer := queue.NewMessageQueue(rdb, "my-stream", "my-group", "consumer-1")
consumer.RegisterHandler(&MyHandler{})

// å¯åŠ¨æ¶ˆè´¹è€…
err := consumer.Start(ctx)
if err != nil {
    log.Fatal(err)
}

// ç›‘å¬è‡ªåŠ¨åœæ­¢
go func() {
    <-consumer.Done()
    if consumer.IsAutoStopped() {
        log.Println("âœ… æ¶ˆè´¹è€…å› topicåˆ é™¤è€Œè‡ªåŠ¨åœæ­¢")
        // æ‰§è¡Œæ¸…ç†é€»è¾‘ï¼Œå¦‚é‡Šæ”¾èµ„æºã€æ›´æ–°çŠ¶æ€ç­‰
    } else {
        log.Println("â„¹ï¸  æ¶ˆè´¹è€…æ‰‹åŠ¨åœæ­¢")
    }
}()

// åœ¨å…¶ä»–åœ°æ–¹åˆ é™¤topic
terminator := queue.NewMessageQueue(rdb, "my-stream", "my-group", "terminator")
err = terminator.TerminateTopic(ctx)
// æ­¤æ—¶æ¶ˆè´¹è€…ä¼šè‡ªåŠ¨åœæ­¢
``` 